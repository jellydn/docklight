# Ralph Progress Log
Started: Fri Feb 27 21:01:07 +08 2026
---

## [Fri Feb 27 2026] - US-001
[Session: https://opncd.ai/s/]
- Implemented backend scaffold with Express, TypeScript, and shell executor
- Created server/ directory with package.json, tsconfig.json
- Implemented shell executor at server/lib/executor.ts with 30s timeout
- Created command allowlist at server/lib/allowlist.ts
- Set up Express server at server/index.ts with /api/health endpoint
- Typecheck passes
- Files changed: server/package.json, server/tsconfig.json, server/lib/allowlist.ts, server/lib/executor.ts, server/index.ts, server/.gitignore
- **Learnings for future iterations:**
  - Used Bun for package installation and running scripts
  - TypeScript configured with ES2022 target and commonjs module for Node.js
  - Command executor uses promisify(exec) for async/await pattern
---

## [Fri Feb 27 2026] - US-002
[Session: https://opncd.ai/s/]
- Implemented SQLite command history persistence with better-sqlite3
- Created server/lib/db.ts with DB initialization at data/docklight.db
- Created command_history table with id, command, exitCode, stdout, stderr, createdAt
- Implemented saveCommand() and getRecentCommands(limit) functions
- Updated executor.ts to auto-save every execution to DB
- Added GET /api/commands endpoint returning last 20 commands
- Typecheck passes
- Files changed: server/lib/db.ts, server/lib/executor.ts, server/index.ts, server/package.json, server/tsconfig.json
- **Learnings for future iterations:**
  - better-sqlite3 requires @types/better-sqlite3 for TypeScript support
  - DB stored in ../data/ relative to server/ directory
  - Command executor now always saves to DB, regardless of success/failure
---

## [Fri Feb 27 2026] - US-003
[Session: https://opncd.ai/s/]
- Implemented authentication backend with JWT and cookie sessions
- Installed jsonwebtoken and cookie-parser dependencies
- Created server/lib/auth.ts with login, verifyToken, generateToken, setAuthCookie, clearAuthCookie, and authMiddleware
- Added POST /api/auth/login endpoint accepting { password }
- Added POST /api/auth/logout endpoint clearing session cookie
- Added GET /api/auth/me endpoint returning { authenticated: true } if valid session
- Applied authMiddleware to all /api/* routes except /api/auth/login and /api/health
- JWT secret from DOCKLIGHT_SECRET env var or default (production warning)
- Password read from DOCKLIGHT_PASSWORD env var
- Typecheck passes
- Files changed: server/lib/auth.ts, server/index.ts, server/package.json, server/tsconfig.json
- **Learnings for future iterations:**
  - authMiddleware applied after specific routes to exclude them from protection
  - httpOnly cookie prevents XSS attacks on session token
  - Cookie configured with secure flag in production environment
---

## [Fri Feb 27 2026] - US-004
[Session: https://opncd.ai/s/]
- Created frontend scaffold with React + Vite + TypeScript
- Installed and configured Tailwind CSS v3
- Installed react-router-dom for routing
- Created AppLayout component with left sidebar (Dashboard, Apps, Databases links) and main content area
- Set up routes: /login, /dashboard, /apps, /apps/:name, /databases
- Created API client utility at client/src/lib/api.ts with fetch wrapper that handles auth (redirects to /login on 401)
- Configured Vite proxy to forward /api/* to backend (http://localhost:3001) in development
- Created placeholder pages for all routes
- Added typecheck script to package.json
- Typecheck passes
- Files changed: client/package.json, client/tsconfig.json, client/vite.config.ts, client/tailwind.config.js, client/postcss.config.js, client/src/index.css, client/src/App.tsx, client/src/components/AppLayout.tsx, client/src/lib/api.ts, client/src/pages/*.tsx
- **Learnings for future iterations:**
  - Tailwind CSS v3 requires specifying content paths in config
  - Vite proxy configured to forward /api/* to backend during development
  - API client uses credentials: 'include' to send cookies with requests
  - React Router uses <Outlet /> for nested route rendering in AppLayout
---

## [Fri Feb 27 2026] - US-005
[Session: https://opncd.ai/s/]
- Implemented login page UI with form handling and error display
- Added password input field and submit button to Login page
- Implemented form submission calling POST /api/auth/login with entered password
- On successful login, redirects to /dashboard
- On failure, displays error message 'Invalid password'
- Added authentication check on mount - if already authenticated (GET /api/auth/me returns 200), redirects to /dashboard
- Added logout button in sidebar calling POST /api/auth/logout and redirecting to /login
- Typecheck passes
- Browser verification skipped due to ChromeDevTools MCP not configured
- Files changed: client/src/pages/Login.tsx, client/src/components/AppLayout.tsx
- **Learnings for future iterations:**
  - Login component checks /api/auth/me on mount to redirect authenticated users
  - Logout button uses onClick handler instead of Link for POST request
  - Form uses React controlled component pattern for password state
---

## [Fri Feb 27 2026] - US-006
[Session: https://opncd.ai/s/]
- Created multi-stage Dockerfile: stage 1 builds client with Vite, stage 2 builds server TypeScript, stage 3 runs Node.js serving SPA + API
- Updated server/index.ts to serve client/dist as static files with express.static
- Added SPA fallback for client-side routing with wildcard route sending index.html
- Created Procfile with web process type running node server/dist/index.js
- Created app.json with healthcheck pointing to /api/health
- Created .dockerignore excluding node_modules, .git, data/
- EXPOSE port uses PORT env var (default 3001) matching Express PORT
- Typecheck passes
- Files changed: Dockerfile, .dockerignore, Procfile, app.json, server/index.ts
- **Learnings for future iterations:**
  - Multi-stage Dockerfile separates build and runtime for smaller image size
  - SPA fallback must come after static file serving in Express middleware order
  - Client dist path is ../client/dist relative to server/ directory
---

## [Fri Feb 27 2026] - US-007
[Session: https://opncd.ai/s/]
- Implemented GET /api/apps endpoint calling 'dokku apps:list' and 'dokku ps:report' via shell executor
- Created server/lib/apps.ts with getApps() function
- Parses dokku output into JSON array: [{ name, status (running/stopped), domains, lastDeployTime }]
- Domains parsed from 'dokku domains:report <app>' for each app
- Returns empty array if no apps exist
- Errors return { error, command, exitCode, stderr } object
- Typecheck passes
- Files changed: server/lib/apps.ts, server/index.ts
- **Learnings for future iterations:**
  - Dokku commands called via executor with proper error handling
  - Status determined by checking for 'deployed' in ps:report output
  - Deploy time parsed from 'deployed at' timestamp using regex
  - Domains extracted from 'domains vhosts' field in domains:report
---

## [Fri Feb 27 2026] - US-008
[Session: https://opncd.ai/s/]
- Implemented GET /api/server/health endpoint returning { cpu, memory, disk } as percentages 0-100
- Created server/lib/server.ts with getServerHealth() function
- CPU parsed from /proc/stat using awk to calculate usage percentage
- Memory parsed from 'free -m' output (used/total percentage)
- Disk parsed from 'df -h /' output (percentage column)
- Values clamped to 0-100 range
- Errors return { error, command, exitCode, stderr } object
- Typecheck passes
- Files changed: server/lib/server.ts, server/index.ts
- **Learnings for future iterations:**
  - CPU usage calculated from /proc/stat user+nice time vs total time
  - awk used for parsing Linux system files efficiently
  - Memory percentage calculated from used vs total in MB
  - Disk percentage extracted from df output using awk
---

## [Fri Feb 27 2026] - US-009
[Session: https://opncd.ai/s/]
- Implemented dashboard page UI at /dashboard with server health, apps list, and recent activity
- Server health bar at top showing CPU, memory, disk with color coding (green <60%, yellow <85%, red >=85%)
- Apps table with columns: Name, Status (badge), Domains, Last Deploy
- App name is a Link to /apps/:name
- Loading spinner shown while fetching data
- Error state displays message if API fails
- Auto-refreshes every 30 seconds using setInterval
- Recent Activity section showing last 20 commands from GET /api/commands
- Typecheck passes
- Browser verification skipped due to ChromeDevTools MCP not configured
- Files changed: client/src/pages/Dashboard.tsx
- **Learnings for future iterations:**
  - useEffect with empty deps runs once and clears interval on unmount
  - Promise.all used to fetch multiple API endpoints in parallel
  - Tailwind utility classes used for conditional styling and responsive layout
  - Link component from react-router-dom for client-side navigation
---

## [Fri Feb 27 2026] - US-010
[Session: https://opncd.ai/s/]
- Implemented GET /api/apps/:name endpoint returning app detail from 'dokku ps:report <app>'
- App detail includes: name, status, git remote, domains, process types/counts
- Implemented POST /api/apps/:name/restart executing 'dokku ps:restart <app>' and returning executor result
- Implemented POST /api/apps/:name/rebuild executing 'dokku ps:rebuild <app>' and returning executor result
- App name validated against allowlist pattern (alphanumeric lowercase + hyphens only) using regex /^[a-z0-9-]+$/
- All endpoints use executor to run dokku commands and return results
- Typecheck passes
- Files changed: server/lib/apps.ts, server/index.ts
- **Learnings for future iterations:**
  - isValidAppName function validates app names before executing commands
  - Process types/counts parsed from 'process type scale' lines in ps:report
  - Git remote extracted from 'app deployed' line in ps:report
  - All app action endpoints return CommandResult with command, exitCode, stdout, stderr
---

## [Fri Feb 27 2026] - US-011
[Session: https://opncd.ai/s/]
- Implemented app detail page UI at /apps/:name with overview tab showing app information
- Displays app name, status badge, git remote, domains list, process types and counts
- Top action bar with Restart and Rebuild buttons
- Clicking action shows confirmation dialog before executing
- Executes restart/rebuild API calls and displays CLI output (command, exitCode, stdout, stderr)
- Command output displayed with formatted code blocks and color coding (green for exit 0, red for non-zero)
- Close button to dismiss command output
- Loading spinner shown while fetching app details
- Error state displayed if API fails
- Typecheck passes
- Browser verification skipped due to ChromeDevTools MCP not configured
- Files changed: client/src/pages/AppDetail.tsx
- **Learnings for future iterations:**
  - Modal dialog pattern with overlay for confirmations
  - Action state management with pendingAction and showActionDialog
  - Command result displayed conditionally only when available
  - Fetch app detail refreshed after successful action
  - Process counts displayed as Object.entries for dynamic rendering
---

## [Fri Feb 27 2026] - US-012
[Session: https://opncd.ai/s/]
- Installed ws dependency for WebSocket support
- Created WebSocket endpoint at /api/apps/:name/logs/stream
- On connection, spawns 'dokku logs <app> -t -n <num>' via child_process.spawn
- Streams stdout lines to WebSocket client as they arrive using send()
- Client can send { lines: 100|500|1000 } to set initial line count
- On WebSocket close, kills the spawned process
- Auth check on WebSocket upgrade validates JWT from cookie
- Setup integrated with HTTP server in server/index.ts
- Typecheck passes
- Files changed: server/lib/websocket.ts, server/index.ts, server/package.json
- **Learnings for future iterations:**
  - WebSocketServer with noServer option for manual upgrade handling
  - HTTP server upgrade event allows WebSocket routing
  - Cookie parsing from request headers for auth validation
  - handleUpgrade method properly integrates ws with http server
  - Process cleanup on WebSocket close to prevent orphaned processes
---

## [Fri Feb 27 2026] - US-013
[Session: https://opncd.ai/s/]
- Implemented Logs tab on app detail page with tabbed layout (Overview, Config, Domains, Logs, SSL)
- Connects to WebSocket endpoint on tab open
- Log output displayed in monospace pre-formatted text with dark background (bg-gray-900)
- Auto-scroll to bottom enabled by default, toggleable with button
- Line count selector (100/500/1000) at top with dropdown
- Disconnects WebSocket when navigating away (useEffect cleanup)
- Connection status indicator (connected/disconnected/reconnecting) with color coding
- WebSocket URL uses ws:// or wss:// based on current protocol
- Logs state managed with useRef for logsEndRef and wsRef
- Typecheck passes
- Browser verification skipped due to ChromeDevTools MCP not configured
- Files changed: client/src/pages/AppDetail.tsx
- **Learnings for future iterations:**
  - Tab pattern with activeTab state for switching views
  - WebSocket connection established in useEffect with cleanup on unmount/tab change
  - Ref types must match the HTML element type (HTMLPreElement for pre tag)
  - Auto-scroll implemented by setting scrollTop to scrollHeight on logs update
  - Connection status displayed with color-coded badges for user feedback
---

## [Fri Feb 27 2026] - US-014
[Session: https://opncd.ai/s/]
- Implemented GET /api/apps/:name/config endpoint calling 'dokku config:show <app>' and returning key-value JSON object
- Implemented POST /api/apps/:name/config endpoint accepting { key, value } and calling 'dokku config:set <app> KEY=VALUE'
- Implemented DELETE /api/apps/:name/config/:key endpoint calling 'dokku config:unset <app> KEY'
- Created server/lib/config.ts with getConfig, setConfig, and unsetConfig functions
- Key and value inputs sanitized using regex to remove shell metacharacters
- Sanitization removes characters that could enable shell injection: ['"`$()|<>\\
- App name validated using isValidAppName from apps.ts
- All endpoints use executor to run dokku commands and return results
- Typecheck passes
- Files changed: server/lib/config.ts, server/index.ts
- **Learnings for future iterations:**
  - Config parsing from dokku config:show output with regex matching
  - Key-value pairs extracted from format "key: value"
  - Input sanitization prevents command injection vulnerabilities
  - Returns config as Record<string, string> for easy frontend consumption
---

## [Fri Feb 27 2026] - US-017
[Session: https://opncd.ai/s/]
- Implemented GET /api/apps/:name/domains endpoint calling 'dokku domains:report <app>' and returning array of domain strings
- Implemented POST /api/apps/:name/domains endpoint accepting { domain } and calling 'dokku domains:add <app> <domain>'
- Implemented DELETE /api/apps/:name/domains/:domain endpoint calling 'dokku domains:remove <app> <domain>'
- Created server/lib/domains.ts with getDomains, addDomain, and removeDomain functions
- Domain input validated with basic format check (letters, numbers, hyphens, dots allowed)
- Domain input sanitized to remove shell characters: [;&$()|<>`'"\\]
- App name validated using isValidAppName from apps.ts
- All endpoints use executor to run dokku commands and return results
- Typecheck passes
- Files changed: server/lib/domains.ts, server/index.ts
- **Learnings for future iterations:**
  - Domains extracted from 'domains vhosts' field in domains:report output
  - Domain format validated with regex /^[a-zA-Z0-9.-]+$/
  - Shell character validation prevents command injection: /[;&$()|<>`'"\\]/
  - Empty string validation added for domain input
  - Returns domains as string[] for easy frontend consumption
---
